{
    "@type": "Workflow",
    "triggerLimit": null,
    "name": "Scenario - Create or Update Asset Records for Scan",
    "aliasName": null,
    "tag": "#PostCreate#Scan",
    "description": "Fetch assets and generates or updates asset records for specified scan from Tenable.io",
    "isActive": true,
    "debug": false,
    "singleRecordExecution": false,
    "remoteExecutableFlag": false,
    "parameters": [
        "scanMetadata"
    ],
    "synchronous": false,
    "collection": "\/api\/3\/workflow_collections\/d99a8b59-a957-4d95-ac1c-da59ec91a117",
    "versions": [],
    "triggerStep": "\/api\/3\/workflow_steps\/97441063-5748-48c0-8281-8b19374c8905",
    "steps": [
        {
            "@type": "WorkflowStep",
            "name": "Configuration",
            "description": null,
            "arguments": {
                "scanId": "{{vars.input.params.scanMetadata.id}}",
                "useMockOutput": "{{globalVars.Demo_mode}}"
            },
            "status": null,
            "top": "120",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "1d6cc3cd-d061-4dad-8c21-d8f8df48edfd"
        },
        {
            "@type": "WorkflowStep",
            "name": "Get Asset Record IRIs",
            "description": null,
            "arguments": {
                "query": {
                    "sort": [],
                    "limit": 30,
                    "logic": "AND",
                    "filters": [
                        {
                            "type": "primitive",
                            "field": "ip",
                            "value": "{{vars.ipList}}",
                            "operator": "in",
                            "_operator": "in"
                        }
                    ],
                    "__selectFields": [
                        "id"
                    ]
                },
                "module": "assets?$limit=30000",
                "checkboxFields": true,
                "step_variables": {
                    "assetIRIs": "{{vars.result | json_query('[].\"@id\"')}}"
                }
            },
            "status": null,
            "top": "520",
            "left": "1060",
            "stepType": "\/api\/3\/workflow_step_types\/b593663d-7d13-40ce-a3a3-96dece928770",
            "group": null,
            "uuid": "2e6ad41e-4409-455b-a8ae-61e47c06c9ae"
        },
        {
            "@type": "WorkflowStep",
            "name": "Link Assets to Scan Record",
            "description": null,
            "arguments": {
                "resource": {
                    "__link": {
                        "assets": "{{vars.assetIRIs}}"
                    }
                },
                "_showJson": true,
                "operation": "Append",
                "collection": "{{vars.steps.Create_New_Scan_Record['@id']}}",
                "__recommend": [],
                "collectionType": "\/api\/3\/scans",
                "fieldOperation": {
                    "recordTags": "Append"
                },
                "step_variables": []
            },
            "status": null,
            "top": "620",
            "left": "1220",
            "stepType": "\/api\/3\/workflow_step_types\/b593663d-7d13-40ce-a3a3-96dece928722",
            "group": null,
            "uuid": "5f808fff-2bb9-4fbf-8fa3-d80ffea2da74"
        },
        {
            "@type": "WorkflowStep",
            "name": "Create New Scan Record",
            "description": null,
            "arguments": {
                "resource": {
                    "name": "{{vars.input.params.scanMetadata.name}}",
                    "state": "{{vars.input.params.scanMetadata.status}}",
                    "scanId": "{{vars.input.params.scanMetadata.id}}",
                    "source": "Tenable.io",
                    "userId": "{{vars.input.params.scanMetadata.owner}}",
                    "__replace": "false",
                    "launchDateTime": "{{vars.input.params.scanMetadata['last_modification_date']}}",
                    "scanReferenceID": "{{vars.input.params.scanMetadata.uuid}}",
                    "isIngestionCompleted": "\/api\/3\/picklists\/711303d3-75ea-437d-a871-0a8d14fcdb7d"
                },
                "_showJson": false,
                "operation": "Overwrite",
                "collection": "\/api\/3\/upsert\/scans",
                "__recommend": [],
                "fieldOperation": {
                    "recordTags": "Overwrite"
                },
                "step_variables": []
            },
            "status": null,
            "top": "220",
            "left": "480",
            "stepType": "\/api\/3\/workflow_step_types\/2597053c-e718-44b4-8394-4d40fe26d357",
            "group": null,
            "uuid": "5f8457cc-5f0c-4a27-a23f-b40b90da2ad5"
        },
        {
            "@type": "WorkflowStep",
            "name": "Step Output",
            "description": null,
            "arguments": {
                "scanIRI": "{{vars.steps.Create_New_Scan_Record['@id']}}",
                "assetIRIList": "{{vars.assetIRIs}}"
            },
            "status": null,
            "top": "720",
            "left": "1380",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "6be0d901-73fe-4a84-8a4b-4346e02653fb"
        },
        {
            "@type": "WorkflowStep",
            "name": "Start",
            "description": null,
            "arguments": {
                "step_variables": {
                    "input": {
                        "params": []
                    },
                    "assetData": "[\n  {\n    \"uuid\": \"2737271e-7142-11ed-b6f2-acde48001122\",\n    \"time_end\": \"2019-01-15T12:38:48.039Z\",\n    \"os\": [\n      \"Microsoft Windows 10 Pro\"\n    ],\n    \"fqdn\": [\n      \"cs-win-11\"\n    ],\n    \"ip\": [\n      \"192.168.0.1\"\n    ],\n    \"mac\": [\n      \"3c:22:fb:28:2e:19\"\n    ],\n    \"time_start\": \"2019-01-15T11:56:35.415Z\"\n  },\n  {\n    \"uuid\": \"273941a2-7142-11ed-b6f2-acde48001122\",\n    \"time_end\": \"2019-01-15T12:38:48.039Z\",\n    \"os\": [\n      \"Microsoft Windows 10 Pro\"\n    ],\n    \"fqdn\": [\n      \"cs-win-12\"\n    ],\n    \"ip\": [\n      \"192.168.0.2\"\n    ],\n    \"mac\": [\n      \"3c:22:fb:28:2e:19\"\n    ],\n    \"time_start\": \"2019-01-15T11:56:35.415Z\"\n  },\n  {\n    \"uuid\": \"273afd08-7142-11ed-b6f2-acde48001122\",\n    \"time_end\": \"2019-01-15T12:38:48.039Z\",\n    \"os\": [\n      \"Microsoft Windows 10 Pro\"\n    ],\n    \"fqdn\": [\n      \"cs-win-13\"\n    ],\n    \"ip\": [\n      \"192.168.0.3\"\n    ],\n    \"mac\": [\n      \"3c:22:fb:28:2e:19\"\n    ],\n    \"time_start\": \"2019-01-15T11:56:35.415Z\"\n  }\n]"
                }
            },
            "status": null,
            "top": "30",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/b348f017-9a94-471f-87f8-ce88b6a7ad62",
            "group": null,
            "uuid": "97441063-5748-48c0-8281-8b19374c8905"
        },
        {
            "@type": "WorkflowStep",
            "name": "Create Asset Records",
            "description": null,
            "arguments": {
                "for_each": {
                    "item": "{{vars.steps.Fetch_Scan_Assets.data}}",
                    "__bulk": true,
                    "parallel": false,
                    "condition": "",
                    "batch_size": 100
                },
                "resource": {
                    "ip": "{{vars.item.ip  | replace(\"[\", \"\") | replace(\"]\",\"\") | replace(\"'\",\"\") }}",
                    "name": "{% if vars.item.fqdn %}{{vars.item.fqdn | replace(\"[\", \"\") | replace(\"]\",\"\") | replace(\"\\\"\",\"\") }}{% else %}{{vars.item.ip  | replace(\"[\", \"\") | replace(\"]\",\"\") | replace(\"'\",\"\") }}{% endif %}",
                    "state": "\/api\/3\/picklists\/b31da3b9-6f87-469e-a1bf-2517c48a7001",
                    "status": "\/api\/3\/picklists\/421c20cd-e63d-4e32-9a25-774b2155cd24",
                    "hostname": "{{vars.item.fqdn | replace(\"[\", \"\") | replace(\"]\",\"\") | replace(\"\\\"\",\"\") }}",
                    "__replace": "",
                    "deviceUid": "{{vars.item.uuid  | replace(\"[\", \"\") | replace(\"]\",\"\") | replace(\"'\",\"\") }}",
                    "macAddress": "{{vars.item.mac  | replace(\"[\", \"\") | replace(\"]\",\"\") | replace(\"'\",\"\") }}",
                    "dateScanned": "{{ arrow.get(vars.item.time_end).timestamp }}",
                    "operatingSystem": "\/api\/3\/picklists\/f0fc6b95-965f-4b65-9b3c-bb3c7f790c1d",
                    "registrationDate": "{{ arrow.get(vars.item.time_start).timestamp }}"
                },
                "collection": "\/api\/ingest-feeds\/assets",
                "__recommend": [],
                "step_variables": []
            },
            "status": null,
            "top": "420",
            "left": "880",
            "stepType": "\/api\/3\/workflow_step_types\/7b221880-716b-4726-a2ca-5e568d330b3e",
            "group": null,
            "uuid": "9fe9c645-783d-487c-b72d-676548ded79f"
        },
        {
            "@type": "WorkflowStep",
            "name": "Fetch Scan Assets",
            "description": null,
            "arguments": {
                "name": "Tenable.io",
                "config": "0427d980-5772-4609-89d8-85cdcac497a1",
                "params": {
                    "scan_id": "{{vars.scanId}}"
                },
                "version": "1.2.0",
                "connector": "tenable-io",
                "operation": "get_scan_assets",
                "mock_result": "{% if vars.scanId == 52 %}\n{\n  \"data\": {{vars.assetData[:2]}},\n  \"status\": \"Success\",\n  \"operation\": \"get_scan_assets\",\n  \"message\": \"\"\n}\n{% else %}\n{\n  \"data\": {{vars.assetData[1:3]}},\n  \"status\": \"Success\",\n  \"operation\": \"get_scan_assets\",\n  \"message\": \"\"\n}\n{% endif %}",
                "operationTitle": "List Scan's Assets",
                "step_variables": {
                    "ipList": "{{vars.result.data | json_query(\"[].ip\")| flatten(levels=1)}}"
                }
            },
            "status": null,
            "top": "320",
            "left": "680",
            "stepType": "\/api\/3\/workflow_step_types\/0bfed618-0316-11e7-93ae-92361f002671",
            "group": null,
            "uuid": "bb059b34-0353-4a3c-9007-136750dac19c"
        }
    ],
    "routes": [
        {
            "@type": "WorkflowRoute",
            "name": "Configuration -> Create New Scan",
            "targetStep": "\/api\/3\/workflow_steps\/5f8457cc-5f0c-4a27-a23f-b40b90da2ad5",
            "sourceStep": "\/api\/3\/workflow_steps\/1d6cc3cd-d061-4dad-8c21-d8f8df48edfd",
            "label": null,
            "isExecuted": false,
            "uuid": "275ff483-1fb2-4259-b0b7-48b0d5554168"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Create New Scan -> Fetch Scan Assets",
            "targetStep": "\/api\/3\/workflow_steps\/bb059b34-0353-4a3c-9007-136750dac19c",
            "sourceStep": "\/api\/3\/workflow_steps\/5f8457cc-5f0c-4a27-a23f-b40b90da2ad5",
            "label": null,
            "isExecuted": false,
            "uuid": "3117227d-b679-4bee-9cc2-5bec7c668d39"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Fetch Scan Assets -> Bulk",
            "targetStep": "\/api\/3\/workflow_steps\/9fe9c645-783d-487c-b72d-676548ded79f",
            "sourceStep": "\/api\/3\/workflow_steps\/bb059b34-0353-4a3c-9007-136750dac19c",
            "label": null,
            "isExecuted": false,
            "uuid": "785fd1ad-4905-471f-b001-dd38fc82ad73"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Update Scan Record -> Step Output",
            "targetStep": "\/api\/3\/workflow_steps\/6be0d901-73fe-4a84-8a4b-4346e02653fb",
            "sourceStep": "\/api\/3\/workflow_steps\/5f808fff-2bb9-4fbf-8fa3-d80ffea2da74",
            "label": null,
            "isExecuted": false,
            "uuid": "9f2402b4-7a45-4fd2-aaa8-f3f10fc8335c"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Start -> Configuration",
            "targetStep": "\/api\/3\/workflow_steps\/1d6cc3cd-d061-4dad-8c21-d8f8df48edfd",
            "sourceStep": "\/api\/3\/workflow_steps\/97441063-5748-48c0-8281-8b19374c8905",
            "label": null,
            "isExecuted": false,
            "uuid": "b3280aae-3063-4a2b-bc2c-7b2580254212"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Find Asset Records Created -> Update Scan Record",
            "targetStep": "\/api\/3\/workflow_steps\/5f808fff-2bb9-4fbf-8fa3-d80ffea2da74",
            "sourceStep": "\/api\/3\/workflow_steps\/2e6ad41e-4409-455b-a8ae-61e47c06c9ae",
            "label": null,
            "isExecuted": false,
            "uuid": "ec4a13b4-3a37-43e8-ae95-e7cc7f8af6c1"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Bulk -> Find Asset Records Created",
            "targetStep": "\/api\/3\/workflow_steps\/2e6ad41e-4409-455b-a8ae-61e47c06c9ae",
            "sourceStep": "\/api\/3\/workflow_steps\/9fe9c645-783d-487c-b72d-676548ded79f",
            "label": null,
            "isExecuted": false,
            "uuid": "ff8ebcf5-c515-4a07-ac20-3291a46521aa"
        }
    ],
    "groups": [],
    "priority": null,
    "uuid": "b16f8616-ed28-4ad0-affa-e0de87359dca",
    "owners": [],
    "isPrivate": false,
    "deletedAt": null,
    "recordTags": [
        "Referenced",
        "Scenario"
    ]
}